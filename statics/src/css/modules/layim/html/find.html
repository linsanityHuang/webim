<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>发现</title>
<link rel="stylesheet" href="/statics/src/css/layui.css">
</head>
<script src="/statics/src/layui.js" charset="utf-8"></script>
<script src="/statics/js/utils.js" charset="utf-8"></script>
<body>
<form class="layui-form" action="">
	<div class="layui-form-item">
		<div class="layui-input-block">
			<select id="search_type" name="interest" lay-filter="search_type">
				<option value="0" selected="">搜索好友</option>
				<option value="1">搜索群聊</option>
			</select>
		</div>
	</div>
	<div class="layui-form-item">
		<div class="layui-input-block">
			<input id="search_input" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入搜索关键字" class="layui-input">
		</div>
	</div>
</form>
<table class="layui-hide" id="test" lay-filter="test"></table>
<script>

var cols_res = null;

layui.use(['layim', 'laypage', 'table', 'form'], function(){
	var layim = layui.layim
	,layer = layui.layer
	,$ = layui.jquery
	,table = layui.table
	,form = layui.form;
	var user_id = parent.layui.layim.cache().mine.id;
	// console.log(user_id);
	// 切换搜索类型的时候清空数据
	form.on('select(search_type)', function (data) {
		// console.log('select');
		// console.log(data.value);
		if (parseInt(data.value) === 0) {
			cols_res = [[
				{field: 'id', title: 'ID', sort: true, fixed: 'left'}
				,{field: 'username', title: '用户名', width:80, sort: true}
		        ,{field: 'sex', title: '性别', width:80, sort: true}
		        ,{field: 'sign', title: '签名', width: 177}
		        ,{field: 'avatar', title: '头像', width:80}
			]]
		}
		else {
			cols_res = [[
				{field: 'id', title: 'ID', sort: true, fixed: 'left'}
				,{field: 'group_chat_name', title: '群名', width:80, sort: true}
		        ,{field: 'avatar', title: '头像', width:80}
			]]
		}
		table.render({
			elem: '#test'
			,height: 312
			,page: true //开启分页
			,cols: cols_res
			,data: []
		});
	});

	$('#search_input').bind('keypress', function(event) {
	    if (event.keyCode === 13) {
	        event.preventDefault();
	        //回车执行查询
		    let search_type = parseInt($('#search_type').val());
		    let key_word = $('#search_input').val();
	        if (key_word !== '' && key_word != null){
	        	// let cols_res = null;
	        	// 搜好友
	        	if (search_type === 0) {
					cols_res = [[
						{field: 'id', title: 'ID', sort: true, fixed: 'left'}
						,{field: 'username', title: '用户名', width:80, sort: true}
				        ,{field: 'sex', title: '性别', width:80, sort: true}
				        ,{field: 'sign', title: '签名', width: 177}
				        ,{field: 'avatar', title: '头像', width:80}
				        // ,{field: 'experience', title: '积分', width: 80, sort: true}
						// ,{field: 'score', title: '评分', width: 80, sort: true}
						// ,{field: 'classify', title: '职业', width: 80}
						// ,{field: 'wealth', title: '财富', width: 135, sort: true}
					]]
		        }
		        // 搜群聊
		        else if (search_type === 1) {
		        	cols_res = [[
						{field: 'id', title: 'ID', sort: true, fixed: 'left'}
						,{field: 'group_chat_name', title: '群名', width:80, sort: true}
				        ,{field: 'avatar', title: '头像', width:80}
					]]
		        }
		        table.render({
					elem: '#test'
					,height: 312
					,url: '/chat/search_friend/' //数据接口
			        ,method: 'post'
			        ,where: {
						search_type: search_type,
						key_word: key_word,
				        user_id: user_id,
			        }
					,page: true //开启分页
					,cols: cols_res
				});
	        }
	    }
	});
	//监听行单击事件
	table.on('row(test)', function(obj){
		// console.log(obj.tr); //得到当前行元素对象
		// console.log(obj.data); //得到当前行数据
		let search_type = parseInt($('#search_type').val());
		if (search_type === 0) {
			layim.add({
				type: 'friend' //friend：申请加好友
				,username: obj.data.username //好友昵称，若申请加群，参数为：groupname
				,avatar: obj.data.avatar //头像
				,submit: function(group, remark, index){ //一般在此执行Ajax和WS，以通知对方
					console.log(group); //获取选择的好友分组ID，若为添加群聊，则不返回值
					console.log(remark); //获取附加信息
					// 这里用户A（Justin）添加用户B（Martin）为好友
					$.ajax({
						url: '/chat/add_friend/',
						type: 'post',
						data: {
							res_type: 'add',
							user_id: user_id,
							friend_id: obj.data.id,
							to_group_id: group,
							remark: remark,
						},
						success: function(data){
							console.log(data);
							layer.close(index); //关闭改面板
						}
					})
				}
			});
		}
		else {
			layim.add({
				type: 'group' // group：申请加群聊
				,groupname: obj.data.group_chat_name //好友昵称，若申请加群，参数为：groupname
				,avatar: obj.data.avatar //头像
				,submit: function(group, remark, index){ //一般在此执行Ajax和WS，以通知对方
					console.log(group); //获取选择的好友分组ID，若为添加群，则不返回值
					console.log(remark); //获取附加信息
					$.ajax({
						url: '/chat/apply_group_chat/',
						type: 'post',
						data: {
							res_type: 'apply_group_chat',
							// 当前用户的ID, 即申请者的ID
							user_id: user_id,
							// 要加入的目标群聊ID
							group_chat_id: obj.data.id,
							remark: remark,
						},
						success: function(data){
							console.log(data);
							layer.close(index); //关闭改面板
						}
					})
				}
			});
		}
	});
});
</script>
</body>
</html>
